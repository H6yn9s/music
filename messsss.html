<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalChat | P2P Мессенджер</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #e6edf3;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            gap: 10px;
        }

        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        .sidebar-section {
            background: rgba(22, 27, 34, 0.8);
            border-radius: 12px;
            border: 1px solid #30363d;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f0f6fc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #58a6ff;
        }

        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
        }

        .glass-card {
            background: rgba(22, 27, 34, 0.8);
            border-radius: 12px;
            border: 1px solid #30363d;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .chat-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #30363d;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #58a6ff, #1f6feb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .chat-info h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #f0f6fc;
        }

        .chat-info p {
            font-size: 0.85rem;
            color: #8b949e;
            margin-top: 2px;
        }

        .online-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #8b949e;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #238636;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(13, 17, 23, 0.5);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(48, 54, 61, 0.3);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease-out;
            line-height: 1.4;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.outgoing {
            align-self: flex-end;
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.incoming {
            align-self: flex-start;
            background: rgba(48, 54, 61, 0.7);
            color: #f0f6fc;
            border-bottom-left-radius: 4px;
            border: 1px solid #30363d;
        }

        .message-system {
            align-self: center;
            background: rgba(88, 166, 255, 0.1);
            color: #8b949e;
            font-size: 0.85rem;
            text-align: center;
            max-width: 90%;
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .message-sender {
            font-weight: 600;
            color: #f0f6fc;
        }

        .message-time {
            color: rgba(255, 255, 255, 0.6);
        }

        .message-text {
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .message-input-container {
            padding: 15px 20px;
            border-top: 1px solid #30363d;
            background: rgba(22, 27, 34, 0.8);
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 12px 16px;
            color: #f0f6fc;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        .message-input::placeholder {
            color: #6e7681;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #58a6ff, #1f6feb);
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: #c9d1d9;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #f0f6fc;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #58a6ff, #1f6feb);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(48, 54, 61, 0.8);
            color: #f0f6fc;
            border: 1px solid #30363d;
        }

        .btn-secondary:hover {
            background: rgba(88, 166, 255, 0.1);
            border-color: #58a6ff;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .room-item {
            padding: 12px 14px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 8px;
            border: 1px solid #30363d;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .room-item:hover {
            background: rgba(88, 166, 255, 0.1);
            border-color: #58a6ff;
        }

        .room-item.active {
            background: rgba(88, 166, 255, 0.15);
            border-color: #58a6ff;
        }

        .room-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #1f6feb, #58a6ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 500;
            color: #f0f6fc;
            margin-bottom: 2px;
        }

        .room-meta {
            font-size: 0.8rem;
            color: #8b949e;
            display: flex;
            gap: 8px;
        }

        .room-users {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-item {
            padding: 10px 12px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 8px;
            border: 1px solid #30363d;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #238636, #2ea043);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            color: #f0f6fc;
            margin-bottom: 2px;
        }

        .user-status {
            font-size: 0.75rem;
            color: #8b949e;
        }

        .connection-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: rgba(35, 134, 54, 0.1);
            border: 1px solid rgba(35, 134, 54, 0.3);
            color: #3fb950;
        }

        .connection-status.disconnected {
            background: rgba(218, 54, 51, 0.1);
            border: 1px solid rgba(218, 54, 51, 0.3);
            color: #f85149;
        }

        .connection-status.waiting {
            background: rgba(255, 211, 77, 0.1);
            border: 1px solid rgba(255, 211, 77, 0.3);
            color: #e3b341;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification i {
            font-size: 1.2rem;
        }

        .notification.success i { color: #3fb950; }
        .notification.error i { color: #f85149; }
        .notification.info i { color: #58a6ff; }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
            color: #f0f6fc;
        }

        .notification-text {
            font-size: 0.9rem;
            color: #8b949e;
        }

        .peer-id {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .id-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .copy-btn {
            background: none;
            border: none;
            color: #58a6ff;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .copy-btn:hover {
            color: #79c0ff;
        }

        .rooms-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .message {
                max-width: 85%;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <!-- Подключение через WebRTC -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-wifi"></i>P2P Подключение</h3>
                <div id="connection-status" class="connection-status disconnected">
                    <span>Не подключено</span>
                    <i class="fas fa-times-circle"></i>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ваше имя</label>
                    <input type="text" id="username-input" class="form-input" placeholder="Введите ваше имя" value="Пользователь">
                </div>
                
                <div class="id-display">
                    <span>Ваш ID:</span>
                    <span id="peer-id" class="peer-id">Генерация...</span>
                    <button id="copy-id-btn" class="copy-btn" title="Скопировать ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID другого пользователя</label>
                    <input type="text" id="remote-peer-id" class="form-input" placeholder="Введите ID собеседника">
                </div>
                
                <button id="connect-btn" class="btn btn-primary">
                    <i class="fas fa-plug"></i>Подключиться
                </button>
                <button id="disconnect-btn" class="btn btn-secondary" style="margin-top: 8px;">
                    <i class="fas fa-unlink"></i>Отключиться
                </button>
            </div>

            <!-- Создать комнату -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-plus-circle"></i>Управление комнатами</h3>
                <div class="rooms-actions">
                    <button id="create-room-btn" class="btn btn-secondary btn-small">
                        <i class="fas fa-plus"></i>Создать
                    </button>
                    <button id="refresh-rooms-btn" class="btn btn-secondary btn-small">
                        <i class="fas fa-sync-alt"></i>Обновить
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Название комнаты</label>
                    <input type="text" id="new-room-name" class="form-input" placeholder="Моя комната">
                </div>
            </div>

            <!-- Список комнат -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-door-open"></i>Доступные комнаты (<span id="rooms-count">0</span>)</h3>
                <div id="rooms-list" class="rooms-list">
                    <!-- Список комнат будет здесь -->
                </div>
            </div>

            <!-- Пользователи онлайн -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-users"></i>В сети (<span id="users-count">0</span>)</h3>
                <div id="users-list" class="users-list">
                    <!-- Список пользователей будет здесь -->
                </div>
            </div>
        </div>

        <!-- Основная панель чата -->
        <div class="main-panel">
            <div class="glass-card chat-header">
                <div class="chat-title">
                    <div class="chat-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="chat-info">
                        <h2 id="current-room-name">Eternall Messanger</h2>
                        <p id="current-room-info">Подключитесь к другому пользователю для общения</p>
                    </div>
                </div>
                <div class="online-indicator">
                    <div class="online-dot"></div>
                    <span id="online-count">0 подключений</span>
                </div>
            </div>

            <div class="glass-card chat-window">
                <div id="messages-container" class="messages-container">
                    <div class="message message-system">
                        Добро пожаловать в Eternall!<br>
                        Для начала общения подключитесь к другому пользователю по его ID.
                    </div>
                    <div class="message message-system">
                        <strong>Как использовать:</strong><br>
                        1. Скопируйте ваш ID и отправьте другу<br>
                        2. Получите ID друга и введите его в поле<br>
                        3. Нажмите "Подключиться"<br>
                        4. Создавайте комнаты и общайтесь!
                    </div>
                </div>
                
                <div class="message-input-container">
                    <div class="message-input-wrapper">
                        <textarea 
                            id="message-input" 
                            class="message-input" 
                            placeholder="Введите сообщение..." 
                            rows="1"
                            disabled
                        ></textarea>
                        <button id="send-btn" class="send-button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notifications-container"></div>

    <script>
        // Используем простой PeerJS для P2P соединений
        // Если хотите использовать свой сервер, можете настроить PeerJS Cloud или локальный сервер
        class P2PChat {
            constructor() {
                this.peer = null;
                this.connections = new Map(); // remotePeerId -> connection
                this.rooms = new Map(); // roomName -> Set of peerIds
                this.currentRoom = 'Основная';
                this.username = 'Пользователь';
                this.users = new Map(); // peerId -> {username, rooms}
                this.myRooms = new Set(['Основная']);
                
                this.init();
            }
            
            init() {
                this.initUI();
                this.setupEventListeners();
                this.generatePeerId();
            }
            
            initUI() {
                this.elements = {
                    connectionStatus: document.getElementById('connection-status'),
                    usernameInput: document.getElementById('username-input'),
                    peerId: document.getElementById('peer-id'),
                    copyIdBtn: document.getElementById('copy-id-btn'),
                    remotePeerId: document.getElementById('remote-peer-id'),
                    connectBtn: document.getElementById('connect-btn'),
                    disconnectBtn: document.getElementById('disconnect-btn'),
                    
                    newRoomName: document.getElementById('new-room-name'),
                    createRoomBtn: document.getElementById('create-room-btn'),
                    refreshRoomsBtn: document.getElementById('refresh-rooms-btn'),
                    roomsCount: document.getElementById('rooms-count'),
                    
                    roomsList: document.getElementById('rooms-list'),
                    usersList: document.getElementById('users-list'),
                    usersCount: document.getElementById('users-count'),
                    
                    currentRoomName: document.getElementById('current-room-name'),
                    currentRoomInfo: document.getElementById('current-room-info'),
                    onlineCount: document.getElementById('online-count'),
                    
                    messagesContainer: document.getElementById('messages-container'),
                    messageInput: document.getElementById('message-input'),
                    sendBtn: document.getElementById('send-btn'),
                    
                    notificationsContainer: document.getElementById('notifications-container')
                };
                
                // Инициализируем комнату по умолчанию
                this.rooms.set('Основная', new Set());
            }
            
            setupEventListeners() {
                // Сохранение имени
                this.elements.usernameInput.addEventListener('change', () => {
                    this.username = this.elements.usernameInput.value.trim() || 'Пользователь';
                    localStorage.setItem('localchat-username', this.username);
                    this.broadcastUserUpdate();
                });
                
                // Копирование ID
                this.elements.copyIdBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(this.elements.peerId.textContent)
                        .then(() => this.showNotification('success', 'Скопировано', 'ID скопирован в буфер обмена'))
                        .catch(() => this.showNotification('error', 'Ошибка', 'Не удалось скопировать ID'));
                });
                
                // Подключение
                this.elements.connectBtn.addEventListener('click', () => this.connectToPeer());
                
                // Отключение
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnectAll());
                
                // Создание комнаты
                this.elements.createRoomBtn.addEventListener('click', () => this.createRoom());
                
                // Обновление комнат
                this.elements.refreshRoomsBtn.addEventListener('click', () => this.updateRoomsList());
                
                // Отправка сообщения
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Авто-высота textarea
                this.elements.messageInput.addEventListener('input', () => {
                    this.elements.messageInput.style.height = 'auto';
                    this.elements.messageInput.style.height = Math.min(this.elements.messageInput.scrollHeight, 120) + 'px';
                });
                
                // Загрузка сохраненного имени
                const savedUsername = localStorage.getItem('localchat-username');
                if (savedUsername) {
                    this.elements.usernameInput.value = savedUsername;
                    this.username = savedUsername;
                }
            }
            
            generatePeerId() {
                // Генерируем случайный ID
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let id = '';
                for (let i = 0; i < 8; i++) {
                    id += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                this.elements.peerId.textContent = id;
                
                // Инициализируем Peer соединение
                this.initializePeer(id);
            }
            
            initializePeer(peerId) {
                try {
                    // Используем простой WebRTC без внешних серверов (для локальной сети)
                    // В реальном приложении нужно настроить STUN/сервер сигналинга
                    const config = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    };
                    
                    // Создаем простой P2P менеджер
                    this.peer = {
                        id: peerId,
                        connections: new Map(),
                        on: (event, callback) => {
                            if (event === 'connection') {
                                this.onConnectionRequest = callback;
                            }
                        },
                        connect: (remoteId) => {
                            return this.createConnection(remoteId);
                        }
                    };
                    
                    this.updateConnectionStatus('ready');
                    this.showNotification('info', 'Готов к подключению', `Ваш ID: ${peerId}`);
                    
                    // Запускаем прием входящих подключений
                    this.startAcceptingConnections();
                    
                } catch (error) {
                    console.error('Ошибка инициализации Peer:', error);
                    this.showNotification('error', 'Ошибка', 'Не удалось инициализировать P2P соединение');
                }
            }
            
            startAcceptingConnections() {
                // Эмулируем прием входящих подключений через localStorage
                setInterval(() => {
                    this.checkForIncomingConnections();
                }, 2000);
            }
            
            checkForIncomingConnections() {
                const incomingKey = `localchat-incoming-${this.peer.id}`;
                const incomingData = localStorage.getItem(incomingKey);
                
                if (incomingData) {
                    try {
                        const data = JSON.parse(incomingData);
                        localStorage.removeItem(incomingKey);
                        
                        if (data.type === 'connect_request') {
                            this.handleIncomingConnection(data.from, data.offer);
                        }
                    } catch (error) {
                        console.error('Ошибка обработки входящего подключения:', error);
                    }
                }
            }
            
            async createConnection(remoteId) {
                if (this.connections.has(remoteId)) {
                    this.showNotification('info', 'Уже подключен', `Вы уже подключены к ${remoteId}`);
                    return;
                }
                
                if (remoteId === this.peer.id) {
                    this.showNotification('error', 'Ошибка', 'Нельзя подключиться к себе');
                    return;
                }
                
                this.updateConnectionStatus('waiting', `Подключение к ${remoteId}...`);
                
                // Создаем фейковое соединение для демонстрации
                const connection = {
                    id: remoteId,
                    send: (data) => this.sendToPeer(remoteId, data),
                    close: () => this.disconnectPeer(remoteId),
                    on: (event, callback) => {
                        if (event === 'data') {
                            connection.dataHandler = callback;
                        }
                    }
                };
                
                this.connections.set(remoteId, connection);
                
                // Отправляем запрос на подключение
                this.sendConnectionRequest(remoteId);
                
                return connection;
            }
            
            sendConnectionRequest(remoteId) {
                const request = {
                    type: 'connect_request',
                    from: this.peer.id,
                    offer: {
                        type: 'offer',
                        sdp: 'fake-sdp-for-demo'
                    },
                    username: this.username,
                    rooms: Array.from(this.myRooms)
                };
                
                // Сохраняем запрос в localStorage (эмуляция сервера сигналинга)
                const requestKey = `localchat-incoming-${remoteId}`;
                localStorage.setItem(requestKey, JSON.stringify(request));
                
                // Устанавливаем таймаут на удаление запроса
                setTimeout(() => {
                    if (localStorage.getItem(requestKey) === JSON.stringify(request)) {
                        localStorage.removeItem(requestKey);
                    }
                }, 30000);
            }
            
            async handleIncomingConnection(from, offer) {
                if (this.connections.has(from)) {
                    return;
                }
                
                const accept = confirm(`Пользователь ${from} хочет подключиться к вам. Принять?`);
                
                if (accept) {
                    // Создаем соединение
                    const connection = {
                        id: from,
                        send: (data) => this.sendToPeer(from, data),
                        close: () => this.disconnectPeer(from),
                        on: (event, callback) => {
                            if (event === 'data') {
                                connection.dataHandler = callback;
                            }
                        }
                    };
                    
                    this.connections.set(from, connection);
                    
                    // Отправляем подтверждение
                    this.sendToPeer(from, {
                        type: 'connection_accepted',
                        from: this.peer.id,
                        username: this.username,
                        rooms: Array.from(this.myRooms)
                    });
                    
                    // Добавляем пользователя
                    this.users.set(from, {
                        username: 'Подключается...',
                        rooms: new Set()
                    });
                    
                    this.updateConnectionStatus('connected');
                    this.updateUsersList();
                    this.showNotification('success', 'Подключено', `Пользователь ${from} подключен`);
                    
                    // Включаем поле ввода
                    this.elements.messageInput.disabled = false;
                    this.elements.sendBtn.disabled = false;
                    
                } else {
                    // Отправляем отказ
                    this.sendToPeer(from, {
                        type: 'connection_rejected',
                        from: this.peer.id
                    });
                }
            }
            
            sendToPeer(peerId, data) {
                // Эмулируем отправку данных через localStorage
                const messageKey = `localchat-message-${peerId}`;
                const message = {
                    from: this.peer.id,
                    data: data,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(messageKey, JSON.stringify(message));
                
                // Устанавливаем таймаут на удаление сообщения
                setTimeout(() => {
                    if (localStorage.getItem(messageKey) === JSON.stringify(message)) {
                        localStorage.removeItem(messageKey);
                    }
                }, 5000);
                
                // Проверяем входящие сообщения
                this.checkForMessages();
            }
            
            checkForMessages() {
                const messageKey = `localchat-message-${this.peer.id}`;
                const messageData = localStorage.getItem(messageKey);
                
                if (messageData) {
                    try {
                        const message = JSON.parse(messageData);
                        localStorage.removeItem(messageKey);
                        
                        const connection = this.connections.get(message.from);
                        if (connection && connection.dataHandler) {
                            connection.dataHandler(message.data);
                        }
                        
                        this.handlePeerMessage(message.from, message.data);
                        
                    } catch (error) {
                        console.error('Ошибка обработки сообщения:', error);
                    }
                }
                
                // Продолжаем проверять сообщения
                setTimeout(() => this.checkForMessages(), 1000);
            }
            
            handlePeerMessage(from, data) {
                switch (data.type) {
                    case 'connection_accepted':
                        this.handleConnectionAccepted(from, data);
                        break;
                    case 'connection_rejected':
                        this.handleConnectionRejected(from);
                        break;
                    case 'chat_message':
                        this.handleChatMessage(from, data);
                        break;
                    case 'room_created':
                        this.handleRoomCreated(from, data);
                        break;
                    case 'room_joined':
                        this.handleRoomJoined(from, data);
                        break;
                    case 'room_left':
                        this.handleRoomLeft(from, data);
                        break;
                    case 'user_update':
                        this.handleUserUpdate(from, data);
                        break;
                    case 'system_message':
                        this.handleSystemMessage(data);
                        break;
                }
            }
            
            handleConnectionAccepted(from, data) {
                this.users.set(from, {
                    username: data.username || 'Аноним',
                    rooms: new Set(data.rooms || [])
                });
                
                // Добавляем общие комнаты
                data.rooms?.forEach(room => {
                    if (this.myRooms.has(room)) {
                        if (!this.rooms.has(room)) {
                            this.rooms.set(room, new Set());
                        }
                        this.rooms.get(room).add(from);
                        this.users.get(from).rooms.add(room);
                    }
                });
                
                this.updateConnectionStatus('connected');
                this.updateUsersList();
                this.updateRoomsList();
                
                this.showNotification('success', 'Подключено', `Подключение к ${from} установлено`);
                this.addSystemMessage(`Подключен к пользователю ${data.username || from}`);
                
                // Включаем поле ввода
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
            }
            
            handleConnectionRejected(from) {
                this.showNotification('error', 'Отклонено', `Пользователь ${from} отклонил подключение`);
                this.connections.delete(from);
                this.updateConnectionStatus('ready');
            }
            
            handleChatMessage(from, data) {
                if (data.room === this.currentRoom) {
                    const user = this.users.get(from);
                    const username = user ? user.username : from;
                    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    this.addMessage(username, data.text, timestamp, 'incoming');
                }
            }
            
            handleRoomCreated(from, data) {
                const roomName = data.room;
                
                if (!this.rooms.has(roomName)) {
                    this.rooms.set(roomName, new Set());
                }
                
                // Добавляем создателя в комнату
                this.rooms.get(roomName).add(from);
                
                const user = this.users.get(from);
                if (user) {
                    user.rooms.add(roomName);
                }
                
                this.updateRoomsList();
                
                if (from !== this.peer.id) {
                    this.showNotification('info', 'Новая комната', `Пользователь ${user?.username || from} создал комнату "${roomName}"`);
                }
            }
            
            handleRoomJoined(from, data) {
                const { room } = data;
                const user = this.users.get(from);
                
                if (user && !user.rooms.has(room)) {
                    user.rooms.add(room);
                    
                    if (!this.rooms.has(room)) {
                        this.rooms.set(room, new Set());
                    }
                    this.rooms.get(room).add(from);
                    
                    this.updateRoomsList();
                    
                    if (room === this.currentRoom && from !== this.peer.id) {
                        this.addSystemMessage(`${user.username} присоединился к комнате`);
                    }
                }
            }
            
            handleRoomLeft(from, data) {
                const { room } = data;
                const user = this.users.get(from);
                
                if (user && user.rooms.has(room)) {
                    user.rooms.delete(room);
                    
                    if (this.rooms.has(room)) {
                        this.rooms.get(room).delete(from);
                        
                        // Если комната пустая и не наша, удаляем её
                        if (this.rooms.get(room).size === 0 && !this.myRooms.has(room)) {
                            this.rooms.delete(room);
                        }
                    }
                    
                    this.updateRoomsList();
                    
                    if (room === this.currentRoom && from !== this.peer.id) {
                        this.addSystemMessage(`${user.username} покинул комнату`);
                    }
                }
            }
            
            handleUserUpdate(from, data) {
                const user = this.users.get(from);
                if (user) {
                    user.username = data.username || user.username;
                    this.updateUsersList();
                }
            }
            
            handleSystemMessage(data) {
                this.addSystemMessage(data.text);
            }
            
            connectToPeer() {
                const remoteId = this.elements.remotePeerId.value.trim();
                if (!remoteId) {
                    this.showNotification('error', 'Ошибка', 'Введите ID другого пользователя');
                    return;
                }
                
                if (remoteId === this.peer.id) {
                    this.showNotification('error', 'Ошибка', 'Нельзя подключиться к себе');
                    return;
                }
                
                this.createConnection(remoteId);
            }
            
            disconnectAll() {
                this.connections.forEach((conn, peerId) => {
                    this.disconnectPeer(peerId);
                });
                
                this.connections.clear();
                this.users.clear();
                
                this.updateConnectionStatus('ready');
                this.updateUsersList();
                
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
                
                this.addSystemMessage('Все подключения разорваны');
                this.showNotification('info', 'Отключено', 'Все соединения разорваны');
            }
            
            disconnectPeer(peerId) {
                const connection = this.connections.get(peerId);
                if (connection) {
                    connection.close();
                    this.connections.delete(peerId);
                    this.users.delete(peerId);
                    
                    // Удаляем пользователя из всех комнат
                    this.rooms.forEach((users, room) => {
                        users.delete(peerId);
                    });
                    
                    this.updateUsersList();
                    this.updateRoomsList();
                }
            }
            
            createRoom() {
                const roomName = this.elements.newRoomName.value.trim();
                if (!roomName) {
                    this.showNotification('error', 'Ошибка', 'Введите название комнаты');
                    return;
                }
                
                if (this.rooms.has(roomName)) {
                    this.showNotification('error', 'Ошибка', `Комната "${roomName}" уже существует`);
                    return;
                }
                
                // Создаем комнату локально
                this.rooms.set(roomName, new Set([this.peer.id]));
                this.myRooms.add(roomName);
                
                // Добавляем себя в комнату
                const myUser = this.users.get(this.peer.id) || { username: this.username, rooms: new Set() };
                myUser.rooms.add(roomName);
                this.users.set(this.peer.id, myUser);
                
                // Рассылаем уведомление о создании комнаты
                this.broadcast({
                    type: 'room_created',
                    room: roomName
                });
                
                // Присоединяемся к созданной комнате
                this.joinRoom(roomName);
                
                this.elements.newRoomName.value = '';
                this.showNotification('success', 'Комната создана', `Комната "${roomName}" создана`);
            }
            
            joinRoom(roomName) {
                if (this.currentRoom === roomName) return;
                
                const previousRoom = this.currentRoom;
                this.currentRoom = roomName;
                
                // Обновляем UI
                this.elements.currentRoomName.textContent = roomName;
                this.elements.currentRoomInfo.textContent = `Комната: ${roomName}`;
                
                // Очищаем сообщения и показываем системное
                this.clearMessages();
                this.addSystemMessage(`Вы присоединились к комнате "${roomName}"`);
                
                // Уведомляем других пользователей
                this.broadcast({
                    type: 'room_joined',
                    room: roomName
                });
                
                // Добавляем себя в список участников комнаты
                if (!this.rooms.has(roomName)) {
                    this.rooms.set(roomName, new Set());
                }
                this.rooms.get(roomName).add(this.peer.id);
                
                // Удаляем себя из предыдущей комнаты (если она не основная)
                if (previousRoom !== 'Основная' && this.rooms.has(previousRoom)) {
                    this.rooms.get(previousRoom).delete(this.peer.id);
                    
                    // Уведомляем о выходе из предыдущей комнаты
                    this.broadcast({
                        type: 'room_left',
                        room: previousRoom
                    });
                }
                
                // Обновляем список комнат
                this.updateRoomsList();
                this.updateUsersList();
            }
            
            sendMessage() {
                const text = this.elements.messageInput.value.trim();
                if (!text) return;
                
                if (this.connections.size === 0) {
                    this.showNotification('error', 'Ошибка', 'Нет подключенных пользователей');
                    return;
                }
                
                // Отправляем сообщение всем в текущей комнате
                this.broadcast({
                    type: 'chat_message',
                    text: text,
                    room: this.currentRoom,
                    timestamp: Date.now()
                });
                
                // Показываем сообщение локально
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                this.addMessage(this.username, text, timestamp, 'outgoing');
                
                // Очищаем поле ввода
                this.elements.messageInput.value = '';
                this.elements.messageInput.style.height = 'auto';
                this.elements.messageInput.focus();
            }
            
            broadcast(data) {
                // Отправляем всем подключенным пользователям
                this.connections.forEach((conn, peerId) => {
                    conn.send(data);
                });
            }
            
            broadcastUserUpdate() {
                this.broadcast({
                    type: 'user_update',
                    username: this.username
                });
                
                // Обновляем локальную информацию
                const myUser = this.users.get(this.peer.id);
                if (myUser) {
                    myUser.username = this.username;
                } else {
                    this.users.set(this.peer.id, {
                        username: this.username,
                        rooms: new Set(Array.from(this.myRooms))
                    });
                }
                
                this.updateUsersList();
            }
            
            addMessage(sender, text, timestamp, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-sender">${sender}</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                    <div class="message-text">${this.escapeHtml(text)}</div>
                `;
                
                this.elements.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-system';
                messageDiv.textContent = text;
                
                this.elements.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            clearMessages() {
                this.elements.messagesContainer.innerHTML = '';
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
                }, 100);
            }
            
            updateConnectionStatus(status, text = '') {
                const statusElement = this.elements.connectionStatus;
                
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusElement.innerHTML = `
                            <span>Подключено (${this.connections.size} пользователей)</span>
                            <i class="fas fa-check-circle"></i>
                        `;
                        break;
                    case 'waiting':
                        statusElement.innerHTML = `
                            <span>${text || 'Ожидание подключения...'}</span>
                            <i class="fas fa-clock"></i>
                        `;
                        break;
                    case 'ready':
                        statusElement.innerHTML = `
                            <span>Готов к подключению</span>
                            <i class="fas fa-wifi"></i>
                        `;
                        break;
                    default:
                        statusElement.innerHTML = `
                            <span>Не подключено</span>
                            <i class="fas fa-times-circle"></i>
                        `;
                }
            }
            
            updateRoomsList() {
                const roomsList = this.elements.roomsList;
                roomsList.innerHTML = '';
                
                this.elements.roomsCount.textContent = this.rooms.size;
                
                if (this.rooms.size === 0) {
                    roomsList.innerHTML = '<div class="room-item"><div class="room-info"><div class="room-name">Нет комнат</div></div></div>';
                    return;
                }
                
                this.rooms.forEach((users, roomName) => {
                    const roomItem = document.createElement('div');
                    roomItem.className = `room-item ${roomName === this.currentRoom ? 'active' : ''}`;
                    
                    const userCount = users.size;
                    const isMyRoom = this.myRooms.has(roomName);
                    
                    roomItem.innerHTML = `
                        <div class="room-icon">
                            <i class="fas ${isMyRoom ? 'fa-crown' : 'fa-hashtag'}"></i>
                        </div>
                        <div class="room-info">
                            <div class="room-name">${roomName} ${isMyRoom ? '(моя)' : ''}</div>
                            <div class="room-meta">
                                <span class="room-users"><i class="fas fa-user"></i> ${userCount}</span>
                            </div>
                        </div>
                    `;
                    
                    roomItem.addEventListener('click', () => {
                        if (roomName !== this.currentRoom) {
                            this.joinRoom(roomName);
                        }
                    });
                    
                    roomsList.appendChild(roomItem);
                });
            }
            
            updateUsersList() {
                const usersList = this.elements.usersList;
                usersList.innerHTML = '';
                
                // Добавляем себя в список
                const allUsers = new Map(this.users);
                allUsers.set(this.peer.id, {
                    username: this.username,
                    rooms: new Set(Array.from(this.myRooms))
                });
                
                // Фильтруем пользователей в текущей комнате
                const usersInRoom = [];
                allUsers.forEach((user, peerId) => {
                    if (user.rooms.has(this.currentRoom) || peerId === this.peer.id) {
                        usersInRoom.push({ peerId, ...user });
                    }
                });
                
                this.elements.usersCount.textContent = usersInRoom.length;
                this.elements.onlineCount.textContent = `${allUsers.size} пользователей в сети`;
                
                if (usersInRoom.length === 0) {
                    usersList.innerHTML = '<div class="user-item"><div class="user-info"><div class="user-name">Нет пользователей</div></div></div>';
                    return;
                }
                
                usersInRoom.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    const firstLetter = user.username.charAt(0).toUpperCase();
                    const isMe = user.peerId === this.peer.id;
                    
                    userItem.innerHTML = `
                        <div class="user-avatar" style="background: ${isMe ? 'linear-gradient(135deg, #58a6ff, #1f6feb)' : 'linear-gradient(135deg, #238636, #2ea043)'}">
                            ${firstLetter}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username} ${isMe ? '(Вы)' : ''}</div>
                            <div class="user-status">${isMe ? 'Вы' : 'В сети'}</div>
                        </div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
            }
            
            showNotification(type, title, text) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                if (type === 'error') icon = 'exclamation-circle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-text">${text}</div>
                    </div>
                `;
                
                this.elements.notificationsContainer.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new P2PChat();
            
            // Показываем инструкции в консоли
            console.log('%c=== LocalChat P2P Instructions ===', 'color: #58a6ff; font-size: 16px; font-weight: bold;');
            console.log('Это P2P версия мессенджера, работающая без сервера.');
            console.log('Для работы через Radmin VPN:');
            console.log('1. Все участники подключаются к одной VPN сети через Radmin');
            console.log('2. Каждый открывает этот файл в браузере');
            console.log('3. Обмениваются ID (копируют из поля "Ваш ID")');
            console.log('4. Вводят ID другого пользователя и нажимают "Подключиться"');
            console.log('5. Принимают входящее подключение');
            console.log('6. Создают комнаты и общаются!');
            console.log('');
            console.log('Примечание: Эта версия использует localStorage для эмуляции P2P соединений.');
            console.log('В реальном приложении нужно использовать WebRTC с STUN серверами.');
            console.log('%c====================================', 'color: #58a6ff; font-size: 16px; font-weight: bold;');
        });
    </script>
</body>
</html>
