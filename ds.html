<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceChat | WebRTC –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            color: white;
            text-align: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tagline {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 25px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.9);
            color: #764ba2;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .room-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .room-id {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .voice-chat-container {
            display: none;
            flex-direction: column;
            height: 500px;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voice-status {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .user-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .avatar-placeholder {
            font-size: 40px;
            color: rgba(255, 255, 255, 0.7);
        }

        .voice-visualizer {
            width: 100%;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 20px 0;
        }

        .voice-bar {
            width: 6px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
            transition: height 0.2s ease;
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        .voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .mic-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #764ba2;
        }

        .mic-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .mic-btn.muted {
            background: rgba(255, 59, 48, 0.8);
            color: white;
        }

        .end-call-btn {
            background: rgba(255, 59, 48, 0.8);
            color: white;
        }

        .end-call-btn:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.05);
        }

        .timer {
            font-size: 24px;
            margin: 10px 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.8;
        }

        .back-btn:hover {
            opacity: 1;
        }

        .participants {
            margin-top: 20px;
        }

        .participant {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .waiting-message {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .audio-element {
            display: none;
        }

        .connection-status {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .ice-state {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div class="glass-card" id="main-screen">
            <div class="logo">VoiceChat</div>
            <div class="tagline">WebRTC –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ª—é–¥—å–º–∏</div>
            
            <button class="btn btn-primary" id="create-room">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="btn btn-secondary" id="join-room">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
            
            <div class="features">
                <div class="feature">üîí P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>
                <div class="feature">üé§ –†–µ–∞–ª—å–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ</div>
                <div class="feature">üåç –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
        <div class="glass-card" id="create-screen" style="display: none;">
            <div class="chat-header">
                <button class="back-btn" id="back-from-create">‚Üê –ù–∞–∑–∞–¥</button>
                <div>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</div>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">–í–∞—à–µ –∏–º—è</label>
                <input type="text" class="input-field" id="host-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            </div>
            
            <button class="btn btn-primary" id="create-room-btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
        <div class="glass-card" id="join-screen" style="display: none;">
            <div class="chat-header">
                <button class="back-btn" id="back-from-join">‚Üê –ù–∞–∑–∞–¥</button>
                <div>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ</div>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">–í–∞—à–µ –∏–º—è</label>
                <input type="text" class="input-field" id="guest-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            </div>
            
            <div class="input-group">
                <label class="input-label">ID –∫–æ–º–Ω–∞—Ç—ã</label>
                <input type="text" class="input-field" id="room-id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
            </div>
            
            <button class="btn btn-primary" id="join-room-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è -->
        <div class="glass-card" id="waiting-screen" style="display: none;">
            <div class="chat-header">
                <button class="back-btn" id="back-from-waiting">‚Üê –ù–∞–∑–∞–¥</button>
                <div>–û–∂–∏–¥–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="room-info">
                <div class="room-id" id="display-room-id">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button class="copy-btn" id="copy-room-id">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            
            <div class="waiting-message">
                –û–∂–∏–¥–∞–µ–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...
                –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å ID –∫–æ–º–Ω–∞—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏
            </div>
            
            <div class="participants" id="waiting-participants">
                <div class="participant">
                    <div class="participant-avatar">üë§</div>
                    <div id="host-participant">–í—ã</div>
                    <div class="connection-status" id="host-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                </div>
            </div>
        </div>

        <!-- –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç -->
        <div class="glass-card voice-chat-container" id="voice-chat-screen">
            <div class="chat-header">
                <button class="back-btn" id="back-from-call">‚Üê –í—ã–π—Ç–∏</button>
                <div>–ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</div>
                <div class="timer" id="call-timer">00:00</div>
            </div>
            
            <div class="voice-status">
                <div class="user-avatar">
                    <div class="avatar-placeholder">üéôÔ∏è</div>
                </div>
                <div class="tagline" id="room-name">–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</div>
                
                <div class="voice-visualizer" id="voice-visualizer">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
                
                <div class="feature" id="connection-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                <div class="ice-state" id="ice-state"></div>
            </div>
            
            <div class="participants" id="participants-list">
                <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="voice-controls">
                <button class="voice-btn mic-btn" id="mic-toggle">
                    <i>üé§</i>
                </button>
                <button class="voice-btn end-call-btn" id="end-call">
                    <i>üìû</i>
                </button>
            </div>
        </div>
    </div>

    <!-- –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∑–≤—É–∫–∞ -->
    <audio id="remote-audio" class="audio-element" autoplay></audio>

    <script>
        class WebRTCVoiceChat {
            constructor() {
                this.peerConnection = null;
                this.localStream = null;
                this.dataChannel = null;
                this.isHost = false;
                this.roomId = null;
                this.userName = null;
                this.participants = new Map();
                this.callTime = 0;
                this.callInterval = null;
                this.isMicMuted = false;
                this.remoteStreams = new Map();
                this.iceConnectionState = 'disconnected';
                
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
                this.rtcConfig = {
                    iceServers: [
                        // –ü—É–±–ª–∏—á–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' },
                        
                        // –ü—É–±–ª–∏—á–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
                        {
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        },
                        {
                            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ],
                    iceCandidatePoolSize: 10,
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                };

                this.iceTransports = 'all'; // –†–∞–∑—Ä–µ—à–∞–µ–º relay —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

                this.initializeElements();
                this.setupEventListeners();
                this.setupSignalingSimulation();
            }

            initializeElements() {
                // –≠–∫—Ä–∞–Ω—ã
                this.screens = {
                    main: document.getElementById('main-screen'),
                    create: document.getElementById('create-screen'),
                    join: document.getElementById('join-screen'),
                    waiting: document.getElementById('waiting-screen'),
                    voice: document.getElementById('voice-chat-screen')
                };

                // –ö–Ω–æ–ø–∫–∏
                this.createRoomBtn = document.getElementById('create-room');
                this.joinRoomBtn = document.getElementById('join-room');
                this.backFromCreateBtn = document.getElementById('back-from-create');
                this.backFromJoinBtn = document.getElementById('back-from-join');
                this.backFromWaitingBtn = document.getElementById('back-from-waiting');
                this.backFromCallBtn = document.getElementById('back-from-call');
                this.createRoomFinalBtn = document.getElementById('create-room-btn');
                this.joinRoomFinalBtn = document.getElementById('join-room-btn');
                this.micToggleBtn = document.getElementById('mic-toggle');
                this.endCallBtn = document.getElementById('end-call');
                this.copyRoomIdBtn = document.getElementById('copy-room-id');

                // –ü–æ–ª—è –≤–≤–æ–¥–∞
                this.hostNameInput = document.getElementById('host-name');
                this.guestNameInput = document.getElementById('guest-name');
                this.roomIdInput = document.getElementById('room-id');

                // –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                this.displayRoomId = document.getElementById('display-room-id');
                this.callTimer = document.getElementById('call-timer');
                this.participantsList = document.getElementById('participants-list');
                this.waitingParticipants = document.getElementById('waiting-participants');
                this.hostParticipant = document.getElementById('host-participant');
                this.hostStatus = document.getElementById('host-status');
                this.notification = document.getElementById('notification');
                this.connectionStatus = document.getElementById('connection-status');
                this.iceStateElement = document.getElementById('ice-state');
                this.remoteAudio = document.getElementById('remote-audio');
            }

            setupEventListeners() {
                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                this.createRoomBtn.addEventListener('click', () => this.showScreen('create'));
                this.joinRoomBtn.addEventListener('click', () => this.showScreen('join'));
                this.backFromCreateBtn.addEventListener('click', () => this.showScreen('main'));
                this.backFromJoinBtn.addEventListener('click', () => this.showScreen('main'));
                this.backFromWaitingBtn.addEventListener('click', () => this.leaveRoom());
                this.backFromCallBtn.addEventListener('click', () => this.leaveRoom());
                this.endCallBtn.addEventListener('click', () => this.leaveRoom());

                // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                this.createRoomFinalBtn.addEventListener('click', () => this.createRoom());
                this.joinRoomFinalBtn.addEventListener('click', () => this.joinRoom());
                this.copyRoomIdBtn.addEventListener('click', () => this.copyRoomId());

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–º
                this.micToggleBtn.addEventListener('click', () => this.toggleMicrophone());
            }

            // –ò–º–∏—Ç–∞—Ü–∏—è signaling —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ localStorage
            setupSignalingSimulation() {
                setInterval(() => {
                    this.checkForSignals();
                }, 1000);
            }

            showScreen(screenName) {
                Object.values(this.screens).forEach(screen => {
                    screen.style.display = 'none';
                });
                this.screens[screenName].style.display = 'block';
            }

            showNotification(message, duration = 3000) {
                this.notification.textContent = message;
                this.notification.style.display = 'block';
                setTimeout(() => {
                    this.notification.style.display = 'none';
                }, duration);
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            async createRoom() {
                const userName = this.hostNameInput.value.trim();
                if (!userName) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                    return;
                }

                this.isHost = true;
                this.roomId = this.generateRoomId();
                this.userName = userName;

                this.displayRoomId.textContent = this.roomId;
                this.hostParticipant.textContent = userName;

                this.showScreen('waiting');
                this.showNotification('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å ID —Å –¥—Ä—É–∑—å—è–º–∏');

                // –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                this.addParticipant(userName, true, 'waiting-participants');
                this.hostStatus.textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é';

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebRTC –∫–∞–∫ —Ö–æ—Å—Ç
                await this.initializeWebRTC(true);
            }

            async joinRoom() {
                const userName = this.guestNameInput.value.trim();
                const roomId = this.roomIdInput.value.trim().toUpperCase();

                if (!userName) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                    return;
                }

                if (!roomId) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                    return;
                }

                this.isHost = false;
                this.roomId = roomId;
                this.userName = userName;

                this.showScreen('voice');
                this.startCallTimer();
                this.animateVoiceVisualizer();

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                this.addParticipant(userName, true, 'participants-list');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebRTC –∫–∞–∫ –≥–æ—Å—Ç—å
                await this.initializeWebRTC(false);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                this.sendSignal({
                    type: 'join',
                    roomId: this.roomId,
                    userName: this.userName
                });

                // –°–æ–∑–¥–∞–µ–º offer –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ö–æ—Å—Ç—É
                try {
                    const offer = await this.peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: false
                    });
                    await this.peerConnection.setLocalDescription(offer);
                    
                    this.sendSignal({
                        type: 'offer',
                        offer: offer,
                        roomId: this.roomId,
                        userName: this.userName
                    });
                } catch (error) {
                    console.error('Error creating offer:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                }
            }

            async initializeWebRTC(isOfferer) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1,
                            sampleRate: 48000,
                            sampleSize: 16
                        },
                        video: false
                    });

                    // –°–æ–∑–¥–∞–µ–º Peer Connection —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
                    this.peerConnection = new RTCPeerConnection(this.rtcConfig);

                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
                    this.peerConnection.ontrack = (event) => {
                        console.log('Received remote track:', event.track.kind);
                        const [remoteStream] = event.streams;
                        const participantId = event.track.id;
                        
                        this.remoteStreams.set(participantId, remoteStream);
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                        this.remoteAudio.srcObject = remoteStream;
                        
                        this.showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å');
                        this.connectionStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                        this.connectionStatus.className = 'feature connection-status connected';
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                        this.updateParticipantStatus(participantId, 'connected');
                    };

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log('Sending ICE candidate:', event.candidate.type);
                            this.sendSignal({
                                type: 'ice-candidate',
                                candidate: event.candidate,
                                roomId: this.roomId,
                                userName: this.userName
                            });
                        } else {
                            console.log('All ICE candidates have been sent');
                        }
                    };

                    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    this.peerConnection.oniceconnectionstatechange = () => {
                        const state = this.peerConnection.iceConnectionState;
                        console.log('ICE connection state:', state);
                        this.iceConnectionState = state;
                        this.updateICEStateDisplay(state);
                        
                        if (state === 'connected' || state === 'completed') {
                            this.showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                            this.connectionStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                        } else if (state === 'disconnected' || state === 'failed') {
                            this.showNotification('–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º...');
                            this.connectionStatus.textContent = '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º';
                        }
                    };

                    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ gathering —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    this.peerConnection.onicegatheringstatechange = () => {
                        console.log('ICE gathering state:', this.peerConnection.iceGatheringState);
                    };

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    this.peerConnection.onconnectionstatechange = () => {
                        const state = this.peerConnection.connectionState;
                        console.log('Connection state:', state);
                        
                        if (state === 'connected') {
                            this.connectionStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                            this.showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                        } else if (state === 'disconnected' || state === 'failed') {
                            this.connectionStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
                            this.showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                        }
                    };

                } catch (error) {
                    console.error('Error initializing WebRTC:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
                }
            }

            updateICEStateDisplay(state) {
                const stateMessages = {
                    'new': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...',
                    'checking': '–ü–æ–∏—Å–∫ –ø—É—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...',
                    'connected': '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (P2P)',
                    'completed': '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ',
                    'disconnected': '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ',
                    'failed': '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
                    'closed': '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ'
                };

                this.iceStateElement.textContent = stateMessages[state] || state;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                if (state === 'connected' || state === 'completed') {
                    this.detectConnectionType();
                }
            }

            async detectConnectionType() {
                if (!this.peerConnection) return;
                
                try {
                    const stats = await this.peerConnection.getStats();
                    let connectionType = 'P2P';
                    
                    stats.forEach(report => {
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            if (report.localCandidateId && report.remoteCandidateId) {
                                const localCandidate = stats.get(report.localCandidateId);
                                const remoteCandidate = stats.get(report.remoteCandidateId);
                                
                                if (localCandidate && remoteCandidate) {
                                    if (localCandidate.candidateType === 'relay' || 
                                        remoteCandidate.candidateType === 'relay') {
                                        connectionType = 'TURN (—Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è)';
                                    } else if (localCandidate.candidateType === 'srflx' || 
                                               remoteCandidate.candidateType === 'srflx') {
                                        connectionType = 'STUN (NAT traversal)';
                                    } else {
                                        connectionType = 'P2P (–ø—Ä—è–º–æ–µ)';
                                    }
                                }
                            }
                        }
                    });
                    
                    this.iceStateElement.textContent += ` ‚Ä¢ ${connectionType}`;
                } catch (error) {
                    console.log('Could not detect connection type:', error);
                }
            }

            async handleSignalingMessage(message) {
                try {
                    if (!this.peerConnection) {
                        console.log('No peer connection, ignoring signal');
                        return;
                    }

                    console.log('Handling signal:', message.type);

                    switch (message.type) {
                        case 'join':
                            if (this.isHost) {
                                this.showNotification(`${message.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`);
                                this.addParticipant(message.userName, false, 'waiting-participants');
                            }
                            break;

                        case 'offer':
                            if (this.isHost) {
                                console.log('Received offer from guest');
                                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                                const answer = await this.peerConnection.createAnswer();
                                await this.peerConnection.setLocalDescription(answer);
                                
                                this.sendSignal({
                                    type: 'answer',
                                    answer: answer,
                                    roomId: this.roomId,
                                    userName: this.userName
                                });

                                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç
                                this.showScreen('voice');
                                this.startCallTimer();
                                this.animateVoiceVisualizer();
                                this.addParticipant(message.userName, false, 'participants-list');
                                this.addParticipant(this.userName, true, 'participants-list');
                            }
                            break;

                        case 'answer':
                            if (!this.isHost) {
                                console.log('Received answer from host');
                                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                                this.addParticipant(message.userName, false, 'participants-list');
                            }
                            break;

                        case 'ice-candidate':
                            try {
                                if (message.candidate) {
                                    await this.peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                                    console.log('Added ICE candidate:', message.candidate.type);
                                }
                            } catch (e) {
                                console.warn('Error adding ICE candidate:', e);
                            }
                            break;
                    }
                } catch (error) {
                    console.error('Error handling signaling message:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
                }
            }

            // –ò–º–∏—Ç–∞—Ü–∏—è signaling —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ localStorage
            sendSignal(message) {
                try {
                    const signals = JSON.parse(localStorage.getItem('webrtc_signals') || '{}');
                    signals[this.roomId] = signals[this.roomId] || [];
                    signals[this.roomId].push({
                        ...message,
                        timestamp: Date.now(),
                        sender: this.userName
                    });
                    localStorage.setItem('webrtc_signals', JSON.stringify(signals));
                } catch (error) {
                    console.error('Error sending signal:', error);
                }
            }

            checkForSignals() {
                if (!this.roomId) return;

                try {
                    const signals = JSON.parse(localStorage.getItem('webrtc_signals') || '{}');
                    const roomSignals = signals[this.roomId] || [];

                    roomSignals.forEach((signal, index) => {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                        if (signal.sender !== this.userName) {
                            this.handleSignalingMessage(signal);
                        }
                    });

                    // –û—á–∏—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                    if (roomSignals.length > 0) {
                        signals[this.roomId] = roomSignals.filter(signal => 
                            signal.sender === this.userName || 
                            Date.now() - signal.timestamp < 30000
                        );
                        localStorage.setItem('webrtc_signals', JSON.stringify(signals));
                    }
                } catch (error) {
                    console.error('Error checking signals:', error);
                }
            }

            copyRoomId() {
                navigator.clipboard.writeText(this.roomId).then(() => {
                    this.showNotification('ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                }).catch(() => {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = this.roomId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showNotification('ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                });
            }

            startCallTimer() {
                this.callTime = 0;
                if (this.callInterval) clearInterval(this.callInterval);
                this.callInterval = setInterval(() => {
                    this.callTime++;
                    const minutes = Math.floor(this.callTime / 60).toString().padStart(2, '0');
                    const seconds = (this.callTime % 60).toString().padStart(2, '0');
                    this.callTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            addParticipant(name, isLocal = true, containerId) {
                const participantId = Date.now().toString();
                this.participants.set(participantId, { name, isLocal, status: 'connecting' });

                const container = containerId === 'waiting-participants' ? 
                    this.waitingParticipants : this.participantsList;

                const participantElement = document.createElement('div');
                participantElement.className = 'participant';
                participantElement.id = `participant-${participantId}`;
                participantElement.innerHTML = `
                    <div class="participant-avatar">üë§</div>
                    <div>${name} ${isLocal ? '(–í—ã)' : ''}</div>
                    <div class="connection-status" id="status-${participantId}">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                `;

                container.appendChild(participantElement);
            }

            updateParticipantStatus(participantId, status) {
                const statusElement = document.getElementById(`status-${participantId}`);
                if (statusElement) {
                    statusElement.textContent = status === 'connected' ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';
                    statusElement.className = `connection-status ${status === 'connected' ? 'connected' : ''}`;
                }
            }

            leaveRoom() {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                if (this.callInterval) {
                    clearInterval(this.callInterval);
                    this.callInterval = null;
                }

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                // –û—á–∏—â–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
                try {
                    const signals = JSON.parse(localStorage.getItem('webrtc_signals') || '{}');
                    delete signals[this.roomId];
                    localStorage.setItem('webrtc_signals', JSON.stringify(signals));
                } catch (error) {
                    console.error('Error cleaning signals:', error);
                }

                // –û—á–∏—â–∞–µ–º –∞—É–¥–∏–æ
                if (this.remoteAudio) {
                    this.remoteAudio.srcObject = null;
                }

                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                document.querySelectorAll('audio').forEach(audio => {
                    if (audio.id !== 'remote-audio') audio.remove();
                });

                this.showScreen('main');
                this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã');

                // –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                this.participants.clear();
                this.participantsList.innerHTML = '';
                this.waitingParticipants.innerHTML = '';
                this.roomId = null;
                this.userName = null;
                this.remoteStreams.clear();
                this.iceConnectionState = 'disconnected';
            }

            toggleMicrophone() {
                if (this.localStream) {
                    const audioTracks = this.localStream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        audioTracks.forEach(track => {
                            track.enabled = !track.enabled;
                        });
                        
                        this.isMicMuted = !this.isMicMuted;
                        if (this.isMicMuted) {
                            this.micToggleBtn.classList.add('muted');
                            this.micToggleBtn.innerHTML = '<i>üîá</i>';
                            this.showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω');
                        } else {
                            this.micToggleBtn.classList.remove('muted');
                            this.micToggleBtn.innerHTML = '<i>üé§</i>';
                            this.showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                        }
                    }
                }
            }

            animateVoiceVisualizer() {
                const bars = document.querySelectorAll('.voice-bar');
                if (bars.length === 0) return;
                
                const updateBars = () => {
                    bars.forEach(bar => {
                        const height = Math.floor(Math.random() * 40) + 10;
                        bar.style.height = `${height}px`;
                        
                        const opacity = Math.random() * 0.5 + 0.5;
                        bar.style.background = `rgba(255, 255, 255, ${opacity})`;
                    });
                    
                    if (this.screens.voice.style.display === 'block') {
                        setTimeout(updateBars, 200);
                    }
                };
                
                updateBars();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            new WebRTCVoiceChat();
        });
    </script>
</body>
</html>
